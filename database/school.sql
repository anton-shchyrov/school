/******************************************************************************/
/***          Generated by IBExpert 2022.1.1.1 17.02.2022 21:45:56          ***/
/******************************************************************************/

SET SQL DIALECT 3;

SET NAMES UTF8;


/******************************************************************************/
/***                                Domains                                 ***/
/******************************************************************************/

CREATE DOMAIN "DM_DATE" AS
DATE;

CREATE DOMAIN "DM_FK" AS
INTEGER;

CREATE DOMAIN "DM_GRADE" AS
SMALLINT
CHECK (VALUE BETWEEN 0 AND 12);

CREATE DOMAIN "DM_GRADE_TYPE" AS
SMALLINT
CHECK (VALUE BETWEEN 0 AND 1);

CREATE DOMAIN "DM_LOGIN" AS
VARCHAR(16) CHARACTER SET UTF8
COLLATE UTF8;

CREATE DOMAIN "DM_NAME" AS
VARCHAR(16) CHARACTER SET UTF8
COLLATE UTF8;

CREATE DOMAIN "DM_PASSWORD" AS
VARCHAR(32) CHARACTER SET UTF8
COLLATE UTF8;

CREATE DOMAIN "DM_PK" AS
INTEGER
NOT NULL;

CREATE DOMAIN "DM_ROLE" AS
SMALLINT
CHECK (VALUE BETWEEN 0 AND 3);

CREATE DOMAIN "DM_USR_NAME" AS
VARCHAR(64) CHARACTER SET UTF8
COLLATE UTF8;

CREATE DOMAIN "DM_USR_TYPE" AS
SMALLINT
CHECK (VALUE BETWEEN 0 AND 3);



/******************************************************************************/
/***                               Exceptions                               ***/
/******************************************************************************/

CREATE EXCEPTION "EX_STUDENT_ONLY" 'This operation is defined for students only';

CREATE EXCEPTION "EX_TEACHER_ONLY" 'This operation is defined for teachers only';

CREATE EXCEPTION "EX_USR_ROLE_CHANGED" 'Can''t change user role';

CREATE EXCEPTION "EX_WRONG_STUDENT_CLASS" 'Student does not belong to this class';



/******************************************************************************/
/***                            Stored functions                            ***/
/******************************************************************************/



SET TERM ^ ;

CREATE OR ALTER FUNCTION "SF_I_USR_ROLE" (
    "IN_USR_ID" INTEGER /* TYPE OF COLUMN "USERS"."ID" */)
RETURNS SMALLINT /* TYPE OF COLUMN "USERS"."ROLE" */
AS
BEGIN
  RETURN NULL;
END^






SET TERM ; ^



/******************************************************************************/
/***                                 Tables                                 ***/
/******************************************************************************/



CREATE TABLE "CLASS_SUBJ" (
    "ID"          "DM_PK" GENERATED BY DEFAULT AS IDENTITY,
    "CLASS_ID"    "DM_FK" NOT NULL,
    "SUBJ_ID"     "DM_FK" NOT NULL,
    "TEACHER_ID"  "DM_FK" NOT NULL
);

CREATE TABLE "CLASSES" (
    "ID"    "DM_PK" GENERATED BY DEFAULT AS IDENTITY,
    "NAME"  "DM_NAME" NOT NULL
);

CREATE TABLE "JOURNAL" (
    "ID"             "DM_PK" GENERATED BY DEFAULT AS IDENTITY,
    "STUDENT_ID"     "DM_FK" NOT NULL,
    "CLASS_SUBJ_ID"  "DM_FK" NOT NULL,
    "DATE"           "DM_DATE" NOT NULL,
    "GRADE"          "DM_GRADE" NOT NULL,
    "GRADE_TYPE"     "DM_GRADE_TYPE"
);

CREATE TABLE "ROLES" (
    "ID"    "DM_ROLE" NOT NULL,
    "NAME"  "DM_NAME" NOT NULL
);

CREATE TABLE "STUDENT_CLASS" (
    "STUDENT_ID"  "DM_FK" NOT NULL,
    "CLASS_ID"    "DM_FK" NOT NULL
);

CREATE TABLE "STUDENTS" (
    "ID"  "DM_PK" NOT NULL
);

CREATE TABLE "SUBJECTS" (
    "ID"    "DM_PK" GENERATED BY DEFAULT AS IDENTITY,
    "NAME"  "DM_NAME" NOT NULL
);

CREATE TABLE "TEACHERS" (
    "ID"  "DM_PK" NOT NULL
);

CREATE TABLE "USERS" (
    "ID"        "DM_PK" GENERATED BY DEFAULT AS IDENTITY,
    "LOGIN"     "DM_LOGIN" NOT NULL,
    "PASSWORD"  "DM_PASSWORD" NOT NULL,
    "NAME"      "DM_USR_NAME" NOT NULL,
    "ROLE"      "DM_ROLE"
);



/******************************************************************************/
/***                                 Views                                  ***/
/******************************************************************************/


/* View: "VW_JOURNAL" */
CREATE VIEW "VW_JOURNAL"(
    "ID",
    "TEACHER_ID",
    "TEACHER_LOGIN",
    "TEACHER_NAME",
    "STUDENT_ID",
    "STUDENT_LOGIN",
    "STUDENT_NAME",
    "CLASS_SUBJ_ID",
    "CLASS_ID",
    "CLASS_NAME",
    "SUBJ_ID",
    "SUBJ_NAME",
    "DATE",
    "GRADE",
    "GRADE_TYPE")
AS
SELECT
  jrn."ID",
  cs."TEACHER_ID",
  teach."LOGIN" AS "TEACHER_LOGIN",
  teach."NAME" AS "TEACHER_NAME",
  jrn."STUDENT_ID",
  std."LOGIN" AS "STUDENT_LOGIN",
  std."NAME" AS "STUDENT_NAME",
  jrn."CLASS_SUBJ_ID",
  cs."CLASS_ID",
  cls."NAME" AS "CLASS_NAME",
  cs."SUBJ_ID",
  subj."NAME" AS "SUBJ_NAME",
  jrn."DATE",
  jrn."GRADE",
  jrn."GRADE_TYPE"
FROM
  journal jrn
  JOIN users std ON (
    jrn."STUDENT_ID" = std."ID"
  )
  JOIN class_subj cs ON (
    jrn."CLASS_SUBJ_ID" = cs."ID"
  )
  JOIN classes cls ON (
    cs."CLASS_ID" = cls."ID"
  )
  JOIN subjects subj ON (
    cs."SUBJ_ID" = subj."ID"
  )
  JOIN users teach ON (
    cs."TEACHER_ID" = teach."ID"
  )
;



/* View: "VW_OWN_STUDENTS" */
CREATE VIEW "VW_OWN_STUDENTS"(
    "TEACH_LOGIN",
    "TEACH_PASSWORD",
    "CLASS",
    "SUBJECT",
    "STUDENT_NAME")
AS
SELECT
  teach."LOGIN" AS "TEACH_LOGIN",
  teach."PASSWORD" AS "TEACH_PASSWORD",
  cls."NAME" AS "CLASS",
  subj."NAME" AS "SUBJECT",
  std."LOGIN" AS "STUDENT_NAME"
FROM
  class_subj cl_subj
  JOIN classes cls ON (
    cl_subj."CLASS_ID" = cls."ID"
  )
  JOIN subjects subj ON (
    cl_subj."SUBJ_ID" = subj."ID"
  )
  JOIN users teach ON (
    cl_subj."TEACHER_ID" = teach."ID"
  )
  JOIN student_class stc ON (
    cl_subj."CLASS_ID" = stc."CLASS_ID"
  )
  JOIN users std ON (
    stc."STUDENT_ID" = std."ID"
  )
;


UPDATE OR INSERT INTO "CLASSES" ("ID", "NAME") VALUES (1, '5A');
UPDATE OR INSERT INTO "CLASSES" ("ID", "NAME") VALUES (2, '6B');
UPDATE OR INSERT INTO "CLASSES" ("ID", "NAME") VALUES (3, '7C');


COMMIT WORK;

UPDATE OR INSERT INTO "SUBJECTS" ("ID", "NAME") VALUES (1, 'Mathematics');
UPDATE OR INSERT INTO "SUBJECTS" ("ID", "NAME") VALUES (2, 'Physics');
UPDATE OR INSERT INTO "SUBJECTS" ("ID", "NAME") VALUES (3, 'Chemistry');
UPDATE OR INSERT INTO "SUBJECTS" ("ID", "NAME") VALUES (4, 'History');
UPDATE OR INSERT INTO "SUBJECTS" ("ID", "NAME") VALUES (5, 'Biology');
UPDATE OR INSERT INTO "SUBJECTS" ("ID", "NAME") VALUES (6, 'Geography');


COMMIT WORK;

UPDATE OR INSERT INTO "ROLES" ("ID", "NAME") VALUES (0, 'admin');
UPDATE OR INSERT INTO "ROLES" ("ID", "NAME") VALUES (1, 'teacher');
UPDATE OR INSERT INTO "ROLES" ("ID", "NAME") VALUES (2, 'student');
UPDATE OR INSERT INTO "ROLES" ("ID", "NAME") VALUES (3, 'staff');


COMMIT WORK;

UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (1, 'admin', 'adm', 'Administrator', 0);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (7, 'teacher', 'teach', 'Teacher', 1);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (37, 'yousef', 'chapman', 'Yousef Chapman', 2);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (38, 'elora', 'hayden', 'Elora Hayden', 2);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (39, 'carlton', 'goff', 'Carlton Goff', 2);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (40, 'joel', 'frederick', 'Joel Frederick', 2);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (41, 'reece', 'atherton', 'Reece Atherton', 2);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (42, 'ethel', 'huff', 'Ethel Huff', 2);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (43, 'arielle', 'greig', 'Arielle Greig', 2);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (44, 'rheanna', 'hume', 'Rheanna Hume', 2);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (45, 'shannon', 'garcia', 'Shannon Garcia', 2);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (46, 'krystal', 'begum', 'Krystal Begum', 2);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (16, 'ellis', 'goff', 'Ellis Goff', 2);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (17, 'clarke', 'gunn', 'Clarke Gunn', 0);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (18, 'hajrah', 'benton', 'Hajrah Benton', 2);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (19, 'gianni', 'lang', 'Gianni Lang', 2);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (20, 'naomi', 'gould', 'Naomi Gould', 1);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (21, 'bobbie', 'pike', 'Bobbie Pike', 0);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (22, 'bronwyn', 'shannon', 'Bronwyn Shannon', 0);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (23, 'melisa', 'nolan', 'Melisa Nolan', 3);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (24, 'sahara', 'crawford', 'Sahara Crawford', 1);
UPDATE OR INSERT INTO "USERS" ("ID", "LOGIN", "PASSWORD", "NAME", "ROLE") VALUES (25, 'samual', 'preece', 'Samual Preece', 3);


COMMIT WORK;

UPDATE OR INSERT INTO "TEACHERS" ("ID") VALUES (7);
UPDATE OR INSERT INTO "TEACHERS" ("ID") VALUES (24);
UPDATE OR INSERT INTO "TEACHERS" ("ID") VALUES (20);


COMMIT WORK;

UPDATE OR INSERT INTO "CLASS_SUBJ" ("ID", "CLASS_ID", "SUBJ_ID", "TEACHER_ID") VALUES (1, 2, 3, 7);
UPDATE OR INSERT INTO "CLASS_SUBJ" ("ID", "CLASS_ID", "SUBJ_ID", "TEACHER_ID") VALUES (3, 3, 1, 20);
UPDATE OR INSERT INTO "CLASS_SUBJ" ("ID", "CLASS_ID", "SUBJ_ID", "TEACHER_ID") VALUES (4, 1, 5, 20);
UPDATE OR INSERT INTO "CLASS_SUBJ" ("ID", "CLASS_ID", "SUBJ_ID", "TEACHER_ID") VALUES (5, 1, 1, 20);
UPDATE OR INSERT INTO "CLASS_SUBJ" ("ID", "CLASS_ID", "SUBJ_ID", "TEACHER_ID") VALUES (6, 2, 2, 7);
UPDATE OR INSERT INTO "CLASS_SUBJ" ("ID", "CLASS_ID", "SUBJ_ID", "TEACHER_ID") VALUES (8, 2, 5, 24);
UPDATE OR INSERT INTO "CLASS_SUBJ" ("ID", "CLASS_ID", "SUBJ_ID", "TEACHER_ID") VALUES (9, 2, 6, 7);


COMMIT WORK;

UPDATE OR INSERT INTO "STUDENTS" ("ID") VALUES (16);
UPDATE OR INSERT INTO "STUDENTS" ("ID") VALUES (18);
UPDATE OR INSERT INTO "STUDENTS" ("ID") VALUES (19);
UPDATE OR INSERT INTO "STUDENTS" ("ID") VALUES (37);
UPDATE OR INSERT INTO "STUDENTS" ("ID") VALUES (38);
UPDATE OR INSERT INTO "STUDENTS" ("ID") VALUES (39);
UPDATE OR INSERT INTO "STUDENTS" ("ID") VALUES (40);
UPDATE OR INSERT INTO "STUDENTS" ("ID") VALUES (41);
UPDATE OR INSERT INTO "STUDENTS" ("ID") VALUES (42);
UPDATE OR INSERT INTO "STUDENTS" ("ID") VALUES (43);
UPDATE OR INSERT INTO "STUDENTS" ("ID") VALUES (44);
UPDATE OR INSERT INTO "STUDENTS" ("ID") VALUES (45);
UPDATE OR INSERT INTO "STUDENTS" ("ID") VALUES (46);


COMMIT WORK;

UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (2, 16, 4, '2022-01-06', 2, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (3, 16, 5, '2022-01-02', 3, 1);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (4, 18, 1, '2022-01-04', 5, 1);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (5, 18, 6, '2022-01-03', 4, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (6, 18, 8, '2022-01-06', 5, 1);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (7, 18, 9, '2022-01-07', 0, 1);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (8, 19, 3, '2022-01-02', 4, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (28, 37, 1, '2022-02-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (27, 38, 1, '2022-02-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (29, 39, 1, '2022-02-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (30, 37, 1, '2022-02-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (31, 38, 1, '2022-02-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (32, 39, 1, '2022-02-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (33, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (34, 37, 1, '2022-02-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (35, 38, 1, '2022-02-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (36, 39, 1, '2022-02-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (37, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (38, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (39, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (40, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (41, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (42, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (43, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (44, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (45, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (46, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (47, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (48, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (49, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (50, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (51, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (52, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (53, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (54, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (55, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (56, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (57, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (58, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (59, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (60, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (61, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (62, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (63, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (64, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (65, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (66, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (67, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (68, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (69, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (70, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (71, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (72, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (73, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (74, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (75, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (76, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (77, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (78, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (79, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (80, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (81, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (82, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (83, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (84, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (85, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (86, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (87, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (88, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (89, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (90, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (91, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (92, 37, 1, '2022-01-01', 3, NULL);
UPDATE OR INSERT INTO "JOURNAL" ("ID", "STUDENT_ID", "CLASS_SUBJ_ID", "DATE", "GRADE", "GRADE_TYPE") VALUES (93, 37, 1, '2022-01-01', 3, NULL);


COMMIT WORK;

UPDATE OR INSERT INTO "STUDENT_CLASS" ("STUDENT_ID", "CLASS_ID") VALUES (37, 2);
UPDATE OR INSERT INTO "STUDENT_CLASS" ("STUDENT_ID", "CLASS_ID") VALUES (38, 2);
UPDATE OR INSERT INTO "STUDENT_CLASS" ("STUDENT_ID", "CLASS_ID") VALUES (39, 2);
UPDATE OR INSERT INTO "STUDENT_CLASS" ("STUDENT_ID", "CLASS_ID") VALUES (16, 1);
UPDATE OR INSERT INTO "STUDENT_CLASS" ("STUDENT_ID", "CLASS_ID") VALUES (18, 2);
UPDATE OR INSERT INTO "STUDENT_CLASS" ("STUDENT_ID", "CLASS_ID") VALUES (19, 3);
UPDATE OR INSERT INTO "STUDENT_CLASS" ("STUDENT_ID", "CLASS_ID") VALUES (40, 2);
UPDATE OR INSERT INTO "STUDENT_CLASS" ("STUDENT_ID", "CLASS_ID") VALUES (41, 2);
UPDATE OR INSERT INTO "STUDENT_CLASS" ("STUDENT_ID", "CLASS_ID") VALUES (42, 2);
UPDATE OR INSERT INTO "STUDENT_CLASS" ("STUDENT_ID", "CLASS_ID") VALUES (43, 2);
UPDATE OR INSERT INTO "STUDENT_CLASS" ("STUDENT_ID", "CLASS_ID") VALUES (44, 2);
UPDATE OR INSERT INTO "STUDENT_CLASS" ("STUDENT_ID", "CLASS_ID") VALUES (45, 2);
UPDATE OR INSERT INTO "STUDENT_CLASS" ("STUDENT_ID", "CLASS_ID") VALUES (46, 2);


COMMIT WORK;



/******************************************************************************/
/***                        Autoincrement generators                        ***/
/******************************************************************************/

ALTER TABLE "CLASSES" ALTER "ID" RESTART WITH 3;
ALTER TABLE "CLASS_SUBJ" ALTER "ID" RESTART WITH 9;
ALTER TABLE "JOURNAL" ALTER "ID" RESTART WITH 93;
ALTER TABLE "SUBJECTS" ALTER "ID" RESTART WITH 6;
ALTER TABLE "USERS" ALTER "ID" RESTART WITH 105;




/******************************************************************************/
/***                           Unique constraints                           ***/
/******************************************************************************/

ALTER TABLE "CLASSES" ADD CONSTRAINT "UNQ_CLASSES_NAME" UNIQUE ("NAME");
ALTER TABLE "CLASS_SUBJ" ADD CONSTRAINT "UNQ_CLASS_SUBJ_SUBJ" UNIQUE ("CLASS_ID", "SUBJ_ID");
ALTER TABLE "STUDENT_CLASS" ADD CONSTRAINT "UNQ_STUDENT_CLASS" UNIQUE ("STUDENT_ID", "CLASS_ID");
ALTER TABLE "SUBJECTS" ADD CONSTRAINT "UNQ_SUBJECTS_NAME" UNIQUE ("NAME");
ALTER TABLE "USERS" ADD CONSTRAINT "UNQ_USERS_LOGIN" UNIQUE ("LOGIN");


/******************************************************************************/
/***                              Primary keys                              ***/
/******************************************************************************/

ALTER TABLE "CLASSES" ADD CONSTRAINT "PK_CLASSES" PRIMARY KEY ("ID");
ALTER TABLE "CLASS_SUBJ" ADD CONSTRAINT "PK_CLASS_SUBJ" PRIMARY KEY ("ID");
ALTER TABLE "JOURNAL" ADD CONSTRAINT "PK_JOURNAL" PRIMARY KEY ("ID");
ALTER TABLE "ROLES" ADD CONSTRAINT "PK_ROLES" PRIMARY KEY ("ID");
ALTER TABLE "STUDENTS" ADD CONSTRAINT "PK_STUDENTS" PRIMARY KEY ("ID");
ALTER TABLE "STUDENT_CLASS" ADD CONSTRAINT "PK_STUDENT_CLASS" PRIMARY KEY ("STUDENT_ID");
ALTER TABLE "SUBJECTS" ADD CONSTRAINT "PK_SUBJECTS" PRIMARY KEY ("ID");
ALTER TABLE "TEACHERS" ADD CONSTRAINT "PK_TEACHERS" PRIMARY KEY ("ID");
ALTER TABLE "USERS" ADD CONSTRAINT "PK_USERS" PRIMARY KEY ("ID");


/******************************************************************************/
/***                              Foreign keys                              ***/
/******************************************************************************/

ALTER TABLE "CLASS_SUBJ" ADD CONSTRAINT "FK_CLASS_SUBJ_CLASS_ID" FOREIGN KEY ("CLASS_ID") REFERENCES "CLASSES" ("ID") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "CLASS_SUBJ" ADD CONSTRAINT "FK_CLASS_SUBJ_SUBJ_ID" FOREIGN KEY ("SUBJ_ID") REFERENCES "SUBJECTS" ("ID") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "CLASS_SUBJ" ADD CONSTRAINT "FK_CLASS_SUBJ_TEACHER_ID" FOREIGN KEY ("TEACHER_ID") REFERENCES "TEACHERS" ("ID") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "JOURNAL" ADD CONSTRAINT "FK_JOURNAL_CLASS_SUBJ_ID" FOREIGN KEY ("CLASS_SUBJ_ID") REFERENCES "CLASS_SUBJ" ("ID") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "JOURNAL" ADD CONSTRAINT "FK_JOURNAL_STUDENT_ID" FOREIGN KEY ("STUDENT_ID") REFERENCES "STUDENTS" ("ID") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "STUDENTS" ADD CONSTRAINT "FK_STUDENTS_ID" FOREIGN KEY ("ID") REFERENCES "USERS" ("ID") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "STUDENT_CLASS" ADD CONSTRAINT "FK_STUDENT_CLASS_CLASS_ID" FOREIGN KEY ("CLASS_ID") REFERENCES "CLASSES" ("ID") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "STUDENT_CLASS" ADD CONSTRAINT "FK_STUDENT_CLASS_STUDENT_ID" FOREIGN KEY ("STUDENT_ID") REFERENCES "STUDENTS" ("ID") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "TEACHERS" ADD CONSTRAINT "FK_TEACHERS_ID" FOREIGN KEY ("ID") REFERENCES "USERS" ("ID") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "USERS" ADD CONSTRAINT "FK_USERS_ROLE" FOREIGN KEY ("ROLE") REFERENCES "ROLES" ("ID") ON UPDATE CASCADE;


/******************************************************************************/
/***                                Triggers                                ***/
/******************************************************************************/



SET TERM ^ ;



/******************************************************************************/
/***                          Triggers for tables                           ***/
/******************************************************************************/



/* Trigger: "TR_CLASSES_BIU0_DEF" */
CREATE OR ALTER TRIGGER "TR_CLASSES_BIU0_DEF" FOR "CLASSES"
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
BEGIN
  NEW."NAME" = UPPER(NEW."NAME");
END
^

/* Trigger: "TR_JOURNAL_BI0_CHK" */
CREATE OR ALTER TRIGGER "TR_JOURNAL_BI0_CHK" FOR "JOURNAL"
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NOT EXISTS (
    SELECT
      1
    FROM
      class_subj cls
      JOIN student_class stc ON (
        stc."CLASS_ID" = cls."CLASS_ID" AND
        stc."STUDENT_ID" = NEW."STUDENT_ID"
      )
    WHERE
      cls."ID" = NEW."CLASS_SUBJ_ID"
  )) THEN
    EXCEPTION ex_wrong_student_class;
END
^

/* Trigger: "TR_STUDENTS_BI0_CHK" */
CREATE OR ALTER TRIGGER "TR_STUDENTS_BI0_CHK" FOR "STUDENTS"
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (sf_i_usr_role(NEW."ID") <> 2) THEN  /* not Student */
    EXCEPTION ex_student_only;
END
^

/* Trigger: "TR_STUDENTS_BU0_CHK" */
CREATE OR ALTER TRIGGER "TR_STUDENTS_BU0_CHK" FOR "STUDENTS"
ACTIVE BEFORE UPDATE POSITION 0
AS
BEGIN
  IF (
    (NEW."ID" <> OLD."ID") AND
    (sf_i_usr_role(NEW."ID") <> 2)  /* not Student */
  ) THEN
    EXCEPTION ex_student_only;
END
^

/* Trigger: "TR_TEACHERS_BI0_CHK" */
CREATE OR ALTER TRIGGER "TR_TEACHERS_BI0_CHK" FOR "TEACHERS"
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (sf_i_usr_role(NEW."ID") <> 1) THEN  /* not Teacher */
    EXCEPTION ex_teacher_only;
END
^

/* Trigger: "TR_TEACHERS_BU0_CHK" */
CREATE OR ALTER TRIGGER "TR_TEACHERS_BU0_CHK" FOR "TEACHERS"
ACTIVE BEFORE UPDATE POSITION 0
AS
BEGIN
  IF (
    (NEW."ID" <> OLD."ID") AND
    (sf_i_usr_role(NEW."ID") <> 1)  /* not Teacher */
  ) THEN
    EXCEPTION ex_teacher_only;
END
^

/* Trigger: "TR_USERS_AI0_SYNC" */
CREATE OR ALTER TRIGGER "TR_USERS_AI0_SYNC" FOR "USERS"
ACTIVE AFTER INSERT POSITION 0
AS
BEGIN
  IF (NEW."ROLE" = 1) THEN  /* Teacher */
    INSERT INTO teachers (
      "ID"
    ) VALUES (
      NEW."ID"
    );
  ELSE IF (NEW."ROLE" = 2) THEN  /* Student */
    INSERT INTO students (
      "ID"
    ) VALUES (
      NEW."ID"
    );
END
^

/* Trigger: "TR_USERS_BIU0_DEF" */
CREATE OR ALTER TRIGGER "TR_USERS_BIU0_DEF" FOR "USERS"
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
BEGIN
  NEW."LOGIN" = LOWER(NEW."LOGIN");
END
^

/* Trigger: "TR_USERS_BU10_CHK" */
CREATE OR ALTER TRIGGER "TR_USERS_BU10_CHK" FOR "USERS"
ACTIVE BEFORE UPDATE POSITION 10
AS
BEGIN
  IF (OLD."ROLE" <> NEW."ROLE") THEN
    EXCEPTION ex_usr_role_changed;
END
^
SET TERM ; ^



/******************************************************************************/
/***                            Stored functions                            ***/
/******************************************************************************/



SET TERM ^ ;

CREATE OR ALTER FUNCTION "SF_I_USR_ROLE" (
    "IN_USR_ID" TYPE OF COLUMN "USERS"."ID")
RETURNS TYPE OF COLUMN "USERS"."ROLE" NOT NULL
AS
DECLARE VARIABLE var_res TYPE OF COLUMN users."ROLE";
BEGIN
  SELECT
    usr."ROLE"
  FROM
    users usr
  WHERE
    usr."ID" = :in_usr_id
  INTO
    :var_res;
  RETURN :var_res;
END^



SET TERM ; ^



/******************************************************************************/
/***                              Descriptions                              ***/
/******************************************************************************/

COMMENT ON DOMAIN "DM_GRADE" IS
'0 - Student absent';

COMMENT ON DOMAIN "DM_GRADE_TYPE" IS
'0 or NULL - Current
1 - Exam';

COMMENT ON DOMAIN "DM_ROLE" IS
'0 - Admin
1 - Teacher
2 - Student
3 - Staff';

COMMENT ON DOMAIN "DM_USR_TYPE" IS
'0 - Admin
1 - Teacher
2 - Student
3 - Staff';



/******************************************************************************/
/***                          Fields descriptions                           ***/
/******************************************************************************/

COMMENT ON COLUMN "JOURNAL"."GRADE" IS
'0 - Student absent';

COMMENT ON COLUMN "JOURNAL"."GRADE_TYPE" IS
'0 or NULL - Current
1 - Exam';

COMMENT ON COLUMN "ROLES"."ID" IS
'0 - Admin
1 - Teacher
2 - Student
3 - Staff';

